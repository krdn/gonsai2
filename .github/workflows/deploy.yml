name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tags
        id: tags
        run: |
          SHA=$(git rev-parse --short HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "backend=${{ env.BACKEND_IMAGE }}:$SHA" >> $GITHUB_OUTPUT
          echo "frontend=${{ env.FRONTEND_IMAGE }}:$SHA" >> $GITHUB_OUTPUT

      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.backend }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/frontend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.frontend }}
            ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=
            NEXT_PUBLIC_WS_URL=
            NEXT_PUBLIC_SOCKET_URL=
            NEXT_PUBLIC_N8N_BASE_URL=http://localhost:5678
            NEXT_PUBLIC_N8N_API_KEY=${{ secrets.N8N_API_KEY }}
            NEXT_PUBLIC_N8N_UI_URL=https://n8n.krdn.kr
            NEXT_PUBLIC_BACKEND_API_KEY=${{ secrets.N8N_API_KEY }}

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 2222
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # GHCR 로그인
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || true

            # 이미지 Pull
            docker pull ${{ steps.tags.outputs.backend }}
            docker pull ${{ steps.tags.outputs.frontend }}

            # 태그 업데이트
            docker tag ${{ steps.tags.outputs.backend }} ${{ env.BACKEND_IMAGE }}:latest
            docker tag ${{ steps.tags.outputs.frontend }} ${{ env.FRONTEND_IMAGE }}:latest

            # 새 컨테이너로 재시작 (pull된 이미지 사용 강제)
            docker compose -f docker-compose.prod.yml up -d --force-recreate --pull always gonsai2-backend gonsai2-frontend

            # 정리
            docker image prune -f

      - name: Summary
        if: always()
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: \`${{ steps.tags.outputs.backend }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: \`${{ steps.tags.outputs.frontend }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
