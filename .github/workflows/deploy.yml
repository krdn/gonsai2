name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd apps/frontend && npm ci
          cd ../backend && npm ci

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: |
          npx tsc --noEmit --project apps/backend/tsconfig.json
          npx tsc --noEmit --project apps/frontend/tsconfig.json

      - name: Run unit tests
        run: npm run test:unit

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped')
    permissions:
      contents: read
      packages: write

    outputs:
      backend-tag: ${{ steps.tags.outputs.backend }}
      frontend-tag: ${{ steps.tags.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tags
        id: tags
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "backend=ghcr.io/${{ github.repository }}/backend:${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "frontend=ghcr.io/${{ github.repository }}/frontend:${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.backend }}
            ghcr.io/${{ github.repository }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/frontend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.frontend }}
            ghcr.io/${{ github.repository }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_WS_URL=${{ vars.NEXT_PUBLIC_WS_URL }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images]
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          BACKEND_IMAGE: ${{ needs.build-images.outputs.backend-tag }}
          FRONTEND_IMAGE: ${{ needs.build-images.outputs.frontend-tag }}
        run: |
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            # Pull latest images
            docker pull ${{ needs.build-images.outputs.backend-tag }}
            docker pull ${{ needs.build-images.outputs.frontend-tag }}

            # Update docker-compose with new image tags
            export BACKEND_IMAGE="${{ needs.build-images.outputs.backend-tag }}"
            export FRONTEND_IMAGE="${{ needs.build-images.outputs.frontend-tag }}"

            # Create backup of current state
            docker compose -f docker-compose.prod.yml config > docker-compose.backup.yml

            # Deploy with zero downtime
            docker compose -f docker-compose.prod.yml up -d --no-deps --scale gonsai2-backend=2 gonsai2-backend
            sleep 10
            docker compose -f docker-compose.prod.yml up -d --no-deps gonsai2-backend

            docker compose -f docker-compose.prod.yml up -d --no-deps gonsai2-frontend

            # Cleanup old images
            docker image prune -f
          ENDSSH

      - name: Health check
        env:
          HEALTH_URL: ${{ vars.PRODUCTION_URL }}/api/health
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Image | \`${{ needs.build-images.outputs.backend-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Image | \`${{ needs.build-images.outputs.frontend-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ vars.PRODUCTION_URL }} |" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure()

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Perform rollback
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "ðŸ”„ Performing rollback..."

            # Restore from backup if exists
            if [ -f docker-compose.backup.yml ]; then
              docker compose -f docker-compose.backup.yml up -d
              echo "âœ… Rollback completed from backup"
            else
              # Fallback to latest stable
              docker compose -f docker-compose.prod.yml down
              docker compose -f docker-compose.prod.yml pull
              docker compose -f docker-compose.prod.yml up -d
              echo "âš ï¸ Rollback to latest stable images"
            fi
          ENDSSH

      - name: Notify rollback
        run: |
          echo "## âš ï¸ Deployment Failed - Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment failed and an automatic rollback was performed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the deployment logs for details." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-production.result }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          mention: 'here'
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}

      - name: Create deployment record
        run: |
          echo "Deployment completed at $(date -u)" >> deployment.log
          echo "Status: ${{ needs.deploy-production.result }}" >> deployment.log
          echo "Commit: ${{ github.sha }}" >> deployment.log
