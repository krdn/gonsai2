name: gonsai2-test
services:
  # Backend Service
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    environment:
      NODE_ENV: test
      PORT: 3000
      HOST: 0.0.0.0
      WS_PORT: 3001
      MONGODB_URI: mongodb://test:test@mongodb:27017/test_db?authSource=admin
      REDIS_URI: redis://redis:6379
      N8N_BASE_URL: http://localhost:5678
      N8N_API_KEY: test_api_key_for_e2e_testing
      ALLOWED_ORIGINS: http://localhost:3002,http://frontend:3002
      LOG_LEVEL: debug
      JWT_SECRET: test_jwt_secret_key_for_e2e_testing_minimum_32_characters
    ports:
      - '3000:3000'
      - '3001:3001'
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      n8n:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Frontend Service
  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:3000
        NEXT_PUBLIC_WS_URL: ws://localhost:3001
        NEXT_PUBLIC_N8N_BASE_URL: http://localhost:5678
    environment:
      NODE_ENV: production
      PORT: 3002
      HOSTNAME: 0.0.0.0
    ports:
      - '3002:3002'
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3002']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MongoDB Service
  mongodb:
    image: mongo:7
    environment:
      MONGO_INITDB_ROOT_USERNAME: test
      MONGO_INITDB_ROOT_PASSWORD: test
      MONGO_INITDB_DATABASE: test_db
    ports:
      - '27017:27017'
    networks:
      - test-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis Service
  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # n8n Service (Required for Backend Startup)
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - N8N_ENCRYPTION_KEY=test-encryption-key
    ports:
      - '5678:5678'
    networks:
      - test-network
    healthcheck:
      test:
        ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:5678/healthz']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  test-network:
    driver: bridge
