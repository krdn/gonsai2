name: gonsai2
services:
  gonsai2-backend:
    build:
      context: /home/gon/projects/gonsai2
      dockerfile: apps/backend/Dockerfile
    cpus: 0.5
    container_name: gonsai2-backend
    depends_on:
      mongodb-prod:
        condition: service_healthy
        required: true
    environment:
      CORS_ORIGINS: http://localhost:8081,http://192.168.0.50:8081,http://krdn.iptime.org:8081
      EMAIL_FROM: noreply@gonsai2.com
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PASSWORD: your-app-password
      EMAIL_PORT: '587'
      EMAIL_SECURE: 'false'
      EMAIL_USER: your-email@gmail.com
      ENABLE_DEBUG_LOGGING: 'false'
      ENABLE_METRICS: 'true'
      ENABLE_SWAGGER_UI: 'false'
      FRONTEND_URL: http://localhost:8081
      HOST: 0.0.0.0
      JWT_EXPIRES_IN: 7d
      JWT_SECRET: d12a71e9ed0cbc7aba5c0958d26791fde3930f9d30c794c51f96a4295753c972
      LOG_FILE_PATH: ./logs
      LOG_LEVEL: info
      LOG_MAX_FILES: 14d
      LOG_MAX_SIZE: 20m
      MAX_FILE_SIZE: '10485760'
      MONGODB_MAX_POOL_SIZE: '100'
      MONGODB_MIN_POOL_SIZE: '10'
      MONGODB_URI: mongodb://gonsai2:gonsai2_prod_password@mongodb-prod:27017/gonsai2_prod?authSource=admin
      N8N_API_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjNGZjZGQ0ZS04M2FhLTRmNTAtODc5Mi1hODU2ZWNhM2YxMGUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYyOTI0MjYwfQ.hyAirUwqDFUmQMGDxiFsONMJpFZxl8dve0Y1xrkkkrc
      N8N_BASE_URL: http://localhost:5678
      N8N_WEBHOOK_SECRET: gonsai2-webhook-secret-production-2024
      NODE_ENV: production
      PORT: '3000'
      RATE_LIMIT_AUTH_MAX: '5'
      RATE_LIMIT_AUTH_WINDOW: '15'
      RATE_LIMIT_MAX_REQUESTS: '100'
      RATE_LIMIT_WINDOW: '15'
      SESSION_SECRET: feb847b396c2f042d5d581e1e5389e435bbe6b4b3327f706a46338fa6bdf0527
      TRUST_PROXY: 'true'
      UPLOAD_DIR: ./uploads
      WS_PATH: /ws
      WS_PORT: '3001'
    extra_hosts:
      - host.docker.internal=host-gateway
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:3000/health
      timeout: 10s
      interval: 30s
      retries: 3
      start_period: 10s
    mem_limit: '268435456'
    networks:
      gonsai2-network: null
      n8n-network: null
    restart: unless-stopped
    volumes:
      - type: volume
        source: backend_logs
        target: /app/logs
        volume: {}
      - type: volume
        source: backend_uploads
        target: /app/uploads
        volume: {}
  gonsai2-frontend:
    build:
      context: /home/gon/projects/gonsai2
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ''
        NEXT_PUBLIC_BACKEND_API_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjNGZjZGQ0ZS04M2FhLTRmNTAtODc5Mi1hODU2ZWNhM2YxMGUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYyOTI0MjYwfQ.hyAirUwqDFUmQMGDxiFsONMJpFZxl8dve0Y1xrkkkrc
        NEXT_PUBLIC_N8N_API_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjNGZjZGQ0ZS04M2FhLTRmNTAtODc5Mi1hODU2ZWNhM2YxMGUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYyOTI0MjYwfQ.hyAirUwqDFUmQMGDxiFsONMJpFZxl8dve0Y1xrkkkrc
        NEXT_PUBLIC_N8N_BASE_URL: http://localhost:5678
        NEXT_PUBLIC_N8N_UI_URL: https://n8n.krdn.kr
        NEXT_PUBLIC_SOCKET_URL: ''
        NEXT_PUBLIC_WS_URL: ''
    cpus: 0.5
    container_name: gonsai2-frontend
    depends_on:
      gonsai2-backend:
        condition: service_healthy
        required: true
    environment:
      BACKEND_INTERNAL_URL: http://gonsai2-backend:3000/api/:path*
      N8N_INTERNAL_URL: http://localhost:5678
      NEXT_PUBLIC_N8N_API_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjNGZjZGQ0ZS04M2FhLTRmNTAtODc5Mi1hODU2ZWNhM2YxMGUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYyOTI0MjYwfQ.hyAirUwqDFUmQMGDxiFsONMJpFZxl8dve0Y1xrkkkrc
      NODE_ENV: production
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:3002
      timeout: 10s
      interval: 30s
      retries: 3
      start_period: 15s
    mem_limit: '268435456'
    networks:
      gonsai2-network: null
      n8n-network: null
    restart: unless-stopped
  mongodb-prod:
    cpus: 0.5
    container_name: gonsai2-mongodb-prod
    environment:
      MONGO_INITDB_DATABASE: gonsai2_prod
      MONGO_INITDB_ROOT_PASSWORD: gonsai2_prod_password
      MONGO_INITDB_ROOT_USERNAME: gonsai2
    healthcheck:
      test:
        - CMD-SHELL
        - echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      timeout: 10s
      interval: 30s
      retries: 5
      start_period: 40s
    image: mongo:7
    mem_limit: '536870912'
    networks:
      gonsai2-network: null
    ports:
      - mode: ingress
        host_ip: 0.0.0.0
        target: 27017
        published: '27018'
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: volume
        source: mongodb_prod_data
        target: /data/db
        volume: {}
      - type: volume
        source: mongodb_prod_config
        target: /data/configdb
        volume: {}
  nginx:
    cpus: 0.25
    container_name: gonsai2-nginx
    depends_on:
      gonsai2-backend:
        condition: service_healthy
        required: true
      gonsai2-frontend:
        condition: service_healthy
        required: true
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1/health
      timeout: 10s
      interval: 30s
      retries: 3
    image: nginx:alpine
    mem_limit: '67108864'
    networks:
      gonsai2-network: null
    ports:
      - mode: ingress
        target: 80
        published: '8081'
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: /home/gon/projects/gonsai2/deployment/nginx/nginx.conf
        target: /etc/nginx/nginx.conf
        read_only: true
        bind:
          create_host_path: true
networks:
  gonsai2-network:
    name: gonsai2_gonsai2-network
    driver: bridge
  n8n-network:
    name: docker-n8n_n8n-network
    external: true
volumes:
  backend_logs:
    name: gonsai2_backend_logs
  backend_uploads:
    name: gonsai2_backend_uploads
  mongodb_prod_config:
    name: gonsai2_mongodb_prod_config
  mongodb_prod_data:
    name: gonsai2_mongodb_prod_data
