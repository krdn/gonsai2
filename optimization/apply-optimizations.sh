#!/bin/bash
# =============================================================================
# n8n ì£¼ê°„ ìµœì í™” ìë™ ì ìš© ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
# ìƒì„±ì¼: 2025-11-12
# ëª©ì : ë¶„ì„ëœ ìµœì í™” ì‚¬í•­ì„ ìë™ìœ¼ë¡œ ì ìš©
# =============================================================================

set -e

# ìƒ‰ìƒ ì¶œë ¥
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ë¡œê¹… í•¨ìˆ˜
log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%H:%M:%S')] ERROR:${NC} $1"
}

warn() {
    echo -e "${YELLOW}[$(date +'%H:%M:%S')] WARN:${NC} $1"
}

info() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')] INFO:${NC} $1"
}

section() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# =============================================================================
# ì‹œì‘
# =============================================================================
section "ğŸ”§ n8n ì£¼ê°„ ìµœì í™” ì ìš©"
log "ìµœì í™” ì‘ì—… ì‹œì‘..."

# =============================================================================
# 1. ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
# =============================================================================
section "1ï¸âƒ£  ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”"

log "PostgreSQL VACUUM ANALYZE ì‹¤í–‰..."
docker exec n8n-postgres psql -U n8n -d n8n -c "VACUUM ANALYZE;" > /dev/null 2>&1
log "âœ“ VACUUM ANALYZE ì™„ë£Œ"

log "ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ì—…ë°ì´íŠ¸..."
docker exec n8n-postgres psql -U n8n -d n8n -c "ANALYZE;" > /dev/null 2>&1
log "âœ“ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

# =============================================================================
# 2. Redis ìºì‹œ ìµœì í™”
# =============================================================================
section "2ï¸âƒ£  Redis ìºì‹œ ìµœì í™”"

log "Redis ìºì‹œ ì •ë¦¬..."
docker exec n8n-redis redis-cli FLUSHDB > /dev/null 2>&1
log "âœ“ ìºì‹œ ì •ë¦¬ ì™„ë£Œ"

log "Redis ì„¤ì • ìµœì í™”..."
# maxmemory ì„¤ì •
docker exec n8n-redis redis-cli CONFIG SET maxmemory 4gb > /dev/null 2>&1
log "âœ“ maxmemory ì„¤ì •: 4GB"

# maxmemory-policy ì„¤ì •
docker exec n8n-redis redis-cli CONFIG SET maxmemory-policy allkeys-lru > /dev/null 2>&1
log "âœ“ maxmemory-policy ì„¤ì •: allkeys-lru"

# persistence ì„¤ì •
docker exec n8n-redis redis-cli CONFIG SET save "900 1 300 10 60 10000" > /dev/null 2>&1
log "âœ“ persistence ì„¤ì • ì™„ë£Œ"

# =============================================================================
# 3. n8n í™˜ê²½ ë³€ìˆ˜ ìµœì í™” (ê¶Œì¥ ì‚¬í•­)
# =============================================================================
section "3ï¸âƒ£  n8n ì„¤ì • ê¶Œì¥ ì‚¬í•­"

info "ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ë¥¼ .env íŒŒì¼ì— ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤:"
echo ""
cat << 'EOF'
# ìë™ ë°ì´í„° ì •ë¦¬
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168  # 7ì¼

# ì„±ëŠ¥ ìµœì í™”
N8N_PAYLOAD_SIZE_MAX=16  # MB
N8N_BINARY_DATA_TTL=60  # minutes

# ì›Œì»¤ ì„¤ì • (ì´ë¯¸ ì ìš©ë¨)
EXECUTIONS_MODE=queue
N8N_METRICS=true
EOF
echo ""

# =============================================================================
# 4. ì›Œí¬í”Œë¡œìš° ì •ë¦¬ ê¶Œì¥
# =============================================================================
section "4ï¸âƒ£  ì›Œí¬í”Œë¡œìš° ì •ë¦¬ ê¶Œì¥"

info "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì›Œí¬í”Œë¡œìš° 7ê°œ ê°ì§€:"
echo "  - Demo: My first AI Agent in n8n"
echo "  - ì“°ë ˆë“œ ìë™í™”"
echo "  - Very quick quickstart"
echo "  - AI agent that can scrape webpages"
echo "  - My workflow 2"
echo "  - My workflow"
echo "  - Newsletter"
echo ""
warn "n8n UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì•„ì¹´ì´ë¸Œí•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”."

# =============================================================================
# 5. ì„±ëŠ¥ ë³‘ëª© í•´ê²° ê¶Œì¥
# =============================================================================
section "5ï¸âƒ£  ì„±ëŠ¥ ë³‘ëª© í•´ê²°"

info "ëŠë¦° ì›Œí¬í”Œë¡œìš° ê°ì§€:"
echo ""
echo "  1. ì§€ì‹ ìŠµë“ í”„ë¡œì„¸ìŠ¤ (í‰ê·  7.69ì´ˆ)"
echo "     â†’ ë³‘ë ¬ ì²˜ë¦¬ ê²€í†  í•„ìš”"
echo ""
echo "  2. gonsai-ì§€ì‹ (í‰ê·  5.22ì´ˆ, ì‹¤íŒ¨ìœ¨ 74%)"
echo "     â†’ Google Gemini ë…¸ë“œì— ì¬ì‹œë„ ì„¤ì • ì ìš© í•„ìš”"
echo "     â†’ Fallback ëª¨ë¸ êµ¬ì„± ê¶Œì¥"
echo ""

# =============================================================================
# 6. ë³´ì•ˆ ì—…ë°ì´íŠ¸ í™•ì¸
# =============================================================================
section "6ï¸âƒ£  ë³´ì•ˆ ìƒíƒœ í™•ì¸"

n8n_version=$(docker exec n8n n8n --version 2>&1 | head -1)
postgres_version=$(docker exec n8n-postgres psql --version | awk '{print $3}')
redis_version=$(docker exec n8n-redis redis-cli INFO server | grep redis_version | cut -d: -f2 | tr -d '\r')

log "n8n ë²„ì „: $n8n_version"
log "PostgreSQL ë²„ì „: $postgres_version"
log "Redis ë²„ì „: $redis_version"
echo ""
info "ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤."

# =============================================================================
# 7. ë¦¬ì†ŒìŠ¤ ì‚¬ìš© í˜„í™©
# =============================================================================
section "7ï¸âƒ£  ë¦¬ì†ŒìŠ¤ ì‚¬ìš© í˜„í™©"

echo "ì»¨í…Œì´ë„ˆë³„ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©:"
docker stats --no-stream n8n n8n-worker n8n-postgres n8n-redis --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

# =============================================================================
# ì™„ë£Œ
# =============================================================================
section "âœ… ìµœì í™” ì™„ë£Œ"

log "ì ìš©ëœ ìµœì í™”:"
echo "  âœ… PostgreSQL VACUUM ANALYZE"
echo "  âœ… Redis ìºì‹œ ì •ë¦¬ ë° ì„¤ì • ìµœì í™”"
echo "  âœ… ì„±ëŠ¥ ë³‘ëª© ë¶„ì„ ë° ê¶Œì¥ ì‚¬í•­ ì œê³µ"
echo ""

log "ìˆ˜ë™ ì ìš© í•„ìš”:"
echo "  â³ Google Gemini ì¬ì‹œë„ ì„¤ì • (n8n UI)"
echo "  â³ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì›Œí¬í”Œë¡œìš° ì•„ì¹´ì´ë¸Œ"
echo "  â³ .env íŒŒì¼ì— ê¶Œì¥ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€"
echo ""

log "ìµœì í™” ì‘ì—… ì™„ë£Œ!"
log "ë‹¤ìŒ ìµœì í™” ì˜ˆì •: $(date -d '+7 days' +'%Y-%m-%d')"

exit 0
