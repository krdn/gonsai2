name: n8n Health Check

on:
  schedule:
    # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Auto-fix errors if detected'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # 1. n8n API ìƒíƒœ í™•ì¸
  check-n8n-api:
    name: Check n8n API Status
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.health.outputs.status }}
      response_time: ${{ steps.health.outputs.response_time }}
    steps:
      - name: Check n8n health endpoint
        id: health
        run: |
          start_time=$(date +%s%N)

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            ${{ secrets.NEXT_PUBLIC_N8N_URL }}/healthz)

          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))

          echo "response_time=$response_time" >> $GITHUB_OUTPUT

          if [ $response -eq 200 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… n8n API is healthy (${response_time}ms)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ n8n API returned status: $response"
            exit 1
          fi

      - name: Check n8n API endpoints
        run: |
          endpoints=(
            "/api/v1/workflows"
            "/api/v1/executions"
            "/api/v1/credentials"
          )

          for endpoint in "${endpoints[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 5 \
              ${{ secrets.NEXT_PUBLIC_N8N_URL }}$endpoint)

            # 200 (ì„±ê³µ) ë˜ëŠ” 401 (ì¸ì¦ í•„ìš”, í•˜ì§€ë§Œ ì—”ë“œí¬ì¸íŠ¸ ì¡´ìž¬) ëª¨ë‘ ì •ìƒ
            if [ $response -eq 200 ] || [ $response -eq 401 ]; then
              echo "âœ… $endpoint: $response"
            else
              echo "âŒ $endpoint: $response"
              exit 1
            fi
          done

  # 2. ì›Œí¬í”Œë¡œìš° ìƒíƒœ ê²€ì¦
  verify-workflows:
    name: Verify Workflow Status
    runs-on: ubuntu-latest
    needs: [check-n8n-api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check active workflows
        id: check_workflows
        run: |
          # n8n APIë¡œ í™œì„± ì›Œí¬í”Œë¡œìš° ì¡°íšŒ (ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš° API í‚¤ ì‚¬ìš©)
          if [ -n "${{ secrets.N8N_API_KEY }}" ]; then
            response=$(curl -s -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
              ${{ secrets.NEXT_PUBLIC_N8N_URL }}/api/v1/workflows?active=true)

            workflow_count=$(echo "$response" | jq -r '.data | length')
            echo "workflow_count=$workflow_count" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Active workflows: $workflow_count"
          else
            echo "âš ï¸ N8N_API_KEY not configured, skipping workflow check"
            echo "workflow_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Check for failed executions
        if: secrets.N8N_API_KEY != ''
        run: |
          # ìµœê·¼ 1ì‹œê°„ ë™ì•ˆì˜ ì‹¤íŒ¨í•œ ì‹¤í–‰ ì¡°íšŒ
          response=$(curl -s -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            "${{ secrets.NEXT_PUBLIC_N8N_URL }}/api/v1/executions?status=error&limit=10")

          error_count=$(echo "$response" | jq -r '.data | length')

          if [ "$error_count" -gt 0 ]; then
            echo "âš ï¸ Found $error_count failed executions in the last hour"
            echo "$response" | jq -r '.data[] | "- \(.workflowName): \(.stoppedAt)"'
          else
            echo "âœ… No failed executions found"
          fi

  # 3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
  check-database:
    name: Check Database Connection
    runs-on: ubuntu-latest
    needs: [check-n8n-api]
    steps:
      - name: Check PostgreSQL connection
        if: secrets.N8N_DB_TYPE == 'postgresdb'
        run: |
          # PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸
          if ! PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql \
            -h ${{ secrets.POSTGRES_HOST }} \
            -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DB }} \
            -c "SELECT 1" > /dev/null 2>&1; then
            echo "âŒ PostgreSQL connection failed"
            exit 1
          fi
          echo "âœ… PostgreSQL connection successful"

      - name: Check Redis connection
        if: secrets.REDIS_HOST != ''
        run: |
          # Redis ì—°ê²° í…ŒìŠ¤íŠ¸
          if ! redis-cli -h ${{ secrets.REDIS_HOST }} ping > /dev/null 2>&1; then
            echo "âŒ Redis connection failed"
            exit 1
          fi
          echo "âœ… Redis connection successful"

  # 4. ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
  check-disk-usage:
    name: Check Disk Usage
    runs-on: ubuntu-latest
    needs: [check-n8n-api]
    if: secrets.DEPLOY_HOST != ''
    steps:
      - name: Check server disk usage
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
            usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

            echo "Disk usage: ${usage}%"

            if [ "$usage" -gt 90 ]; then
              echo "âŒ Critical: Disk usage above 90%"
              exit 1
            elif [ "$usage" -gt 80 ]; then
              echo "âš ï¸ Warning: Disk usage above 80%"
            else
              echo "âœ… Disk usage is normal"
            fi

            # n8n ë°ì´í„° ë””ë ‰í† ë¦¬ í¬ê¸° í™•ì¸
            if [ -d ~/docker-n8n/data ]; then
              data_size=$(du -sh ~/docker-n8n/data | cut -f1)
              echo "n8n data directory size: $data_size"
            fi

  # 5. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
  check-memory:
    name: Check Memory Usage
    runs-on: ubuntu-latest
    needs: [check-n8n-api]
    if: secrets.DEPLOY_HOST != ''
    steps:
      - name: Check server memory usage
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
            memory_usage=$(free | awk 'NR==2 {printf "%.0f", $3/$2 * 100}')

            echo "Memory usage: ${memory_usage}%"

            if [ "$memory_usage" -gt 90 ]; then
              echo "âŒ Critical: Memory usage above 90%"
              exit 1
            elif [ "$memory_usage" -gt 80 ]; then
              echo "âš ï¸ Warning: Memory usage above 80%"
            else
              echo "âœ… Memory usage is normal"
            fi

            # Docker ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
            echo ""
            echo "Docker container memory usage:"
            docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}"

  # 6. ì˜¤ë¥˜ ìžë™ ìˆ˜ì •
  auto-fix:
    name: Auto Fix Errors
    runs-on: ubuntu-latest
    needs: [check-n8n-api, verify-workflows, check-database, check-disk-usage, check-memory]
    if: failure() && (github.event.inputs.auto_fix == 'true' || github.event_name == 'schedule')
    steps:
      - name: Identify error type
        id: identify
        run: |
          if [ "${{ needs.check-n8n-api.result }}" == "failure" ]; then
            echo "error_type=api_down" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-database.result }}" == "failure" ]; then
            echo "error_type=database_down" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-disk-usage.result }}" == "failure" ]; then
            echo "error_type=disk_full" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-memory.result }}" == "failure" ]; then
            echo "error_type=memory_high" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Restart n8n service
        if: steps.identify.outputs.error_type == 'api_down'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ~/docker-n8n
            echo "ðŸ”„ Restarting n8n services..."
            docker-compose restart n8n n8n-worker
            sleep 30

            # ìž¬ì‹œìž‘ í›„ í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:5678/healthz; then
              echo "âœ… n8n service restarted successfully"
            else
              echo "âŒ n8n service restart failed"
              exit 1
            fi

      - name: Restart database
        if: steps.identify.outputs.error_type == 'database_down'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ~/docker-n8n
            echo "ðŸ”„ Restarting database services..."
            docker-compose restart postgres redis
            sleep 20

            # ë°ì´í„°ë² ì´ìŠ¤ ìž¬ì‹œìž‘ í›„ n8në„ ìž¬ì‹œìž‘
            docker-compose restart n8n n8n-worker
            sleep 30

      - name: Clean up disk space
        if: steps.identify.outputs.error_type == 'disk_full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            echo "ðŸ§¹ Cleaning up disk space..."

            # Docker ì •ë¦¬
            docker system prune -af --volumes

            # ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬ (30ì¼ ì´ìƒ)
            find ~/docker-n8n/backup -name "*.tar.gz" -mtime +30 -delete

            # ë¡œê·¸ ì •ë¦¬
            find ~/docker-n8n/logs -name "*.log" -mtime +7 -delete

            echo "âœ… Disk cleanup completed"
            df -h /

      - name: Optimize memory
        if: steps.identify.outputs.error_type == 'memory_high'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            echo "ðŸ”„ Optimizing memory usage..."

            # ë¯¸ì‚¬ìš© Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker container prune -f

            # ì‹œìŠ¤í…œ ìºì‹œ í´ë¦¬ì–´
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches

            echo "âœ… Memory optimization completed"
            free -h

  # 7. ì•Œë¦¼ ë°œì†¡
  send-notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs:
      [check-n8n-api, verify-workflows, check-database, check-disk-usage, check-memory, auto-fix]
    if: always()
    steps:
      - name: Generate health report
        run: |
          echo "## ðŸ¥ n8n Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # n8n API ìƒíƒœ
          if [ "${{ needs.check-n8n-api.result }}" == "success" ]; then
            echo "- âœ… n8n API: Healthy (Response time: ${{ needs.check-n8n-api.outputs.response_time }}ms)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ n8n API: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi

          # ì›Œí¬í”Œë¡œìš° ìƒíƒœ
          if [ "${{ needs.verify-workflows.result }}" == "success" ]; then
            echo "- âœ… Workflows: Verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Workflows: Issues detected" >> $GITHUB_STEP_SUMMARY
          fi

          # ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ
          if [ "${{ needs.check-database.result }}" == "success" ]; then
            echo "- âœ… Database: Connected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Database: Connection failed" >> $GITHUB_STEP_SUMMARY
          fi

          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
          if [ "${{ needs.check-disk-usage.result }}" == "success" ]; then
            echo "- âœ… Disk Usage: Normal" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Disk Usage: Warning" >> $GITHUB_STEP_SUMMARY
          fi

          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
          if [ "${{ needs.check-memory.result }}" == "success" ]; then
            echo "- âœ… Memory Usage: Normal" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Memory Usage: Warning" >> $GITHUB_STEP_SUMMARY
          fi

          # ìžë™ ìˆ˜ì • ê²°ê³¼
          if [ "${{ needs.auto-fix.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Auto-fix Applied" >> $GITHUB_STEP_SUMMARY
            echo "Issues were automatically resolved." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.auto-fix.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Manual Intervention Required" >> $GITHUB_STEP_SUMMARY
            echo "Auto-fix failed. Please check manually." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send alert on failure
        if: failure()
        run: |
          echo "ðŸš¨ Health check failed!"
          echo "Check the workflow summary for details."
          echo "URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
