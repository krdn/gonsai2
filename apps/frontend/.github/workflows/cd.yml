name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/frontend

jobs:
  # 1. ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_N8N_URL=${{ secrets.NEXT_PUBLIC_N8N_URL }}
            NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}
            NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}

      - name: Generate build summary
        run: |
          echo "## üê≥ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # 2. Í∏∞Ï°¥ n8n Ïª®ÌÖåÏù¥ÎÑàÏôÄ Ïó∞Îèô ÌÖåÏä§Ìä∏
  integration-test:
    name: Integration Test with n8n
    runs-on: ubuntu-latest
    needs: [build-and-push]
    services:
      n8n:
        image: docker.n8n.io/n8nio/n8n:latest
        ports:
          - 5678:5678
        env:
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
          DB_TYPE: sqlite
          N8N_PROTOCOL: http
          N8N_HOST: localhost
          N8N_PORT: 5678
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:5678/healthz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run application container
        run: |
          docker pull ${{ needs.build-and-push.outputs.image-tag }}
          docker run -d \
            --name frontend \
            --network ${{ job.services.n8n.network }} \
            -p 3000:3000 \
            -e NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
            -e NEXT_PUBLIC_N8N_URL=http://n8n:5678 \
            -e NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }} \
            -e NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }} \
            ${{ needs.build-and-push.outputs.image-tag }}

      - name: Wait for application to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done' || true
          sleep 5

      - name: Test n8n connectivity from container
        run: |
          docker exec frontend curl -f http://n8n:5678/healthz
          echo "‚úÖ n8n connectivity verified"

      - name: Cleanup
        if: always()
        run: |
          docker stop frontend || true
          docker rm frontend || true

  # 3. Î∞∞Ìè¨ Ï§ÄÎπÑ
  prepare-deployment:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    needs: [build-and-push, integration-test]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment manifest
        run: |
          mkdir -p deploy
          cat > deploy/docker-compose.yml <<EOF
          version: '3.8'

          services:
            frontend:
              image: ${{ needs.build-and-push.outputs.image-tag }}
              container_name: gonsai2-frontend
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                - NEXT_PUBLIC_API_URL=\${NEXT_PUBLIC_API_URL}
                - NEXT_PUBLIC_N8N_URL=\${NEXT_PUBLIC_N8N_URL}
                - NEXT_PUBLIC_SOCKET_URL=\${NEXT_PUBLIC_SOCKET_URL}
                - NEXT_PUBLIC_WS_URL=\${NEXT_PUBLIC_WS_URL}
              networks:
                - n8n-network
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

          networks:
            n8n-network:
              external: true
          EOF

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifest
          path: deploy/
          retention-days: 7

  # 4. Î∞∞Ìè¨ Ïã§Ìñâ
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [build-and-push, prepare-deployment]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.APP_URL }}
    steps:
      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-manifest
          path: deploy/

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Create deployment directory
            mkdir -p ~/gonsai2-frontend
            cd ~/gonsai2-frontend

            # Backup current deployment
            if [ -f docker-compose.yml ]; then
              echo "Creating backup..."
              cp docker-compose.yml docker-compose.yml.backup
              docker-compose ps > deployment-state.backup
            fi

            # Save environment variables
            cat > .env <<EOF
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_N8N_URL=${{ secrets.NEXT_PUBLIC_N8N_URL }}
            NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}
            NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
            EOF

            # Login to registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.DOCKER_REGISTRY }} -u ${{ github.actor }} --password-stdin

            # Pull new image
            docker pull ${{ needs.build-and-push.outputs.image-tag }}

            # Update deployment
            echo "Stopping current deployment..."
            docker-compose down || true

            # Upload new docker-compose.yml (from artifact)
            cat > docker-compose.yml <<'EOF'
            ${{ steps.download-artifact.outputs.path }}/docker-compose.yml
            EOF

            # Start new deployment
            echo "Starting new deployment..."
            docker-compose up -d

            # Wait for health check
            echo "Waiting for application to be healthy..."
            sleep 10

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ~/gonsai2-frontend

            # Check container status
            if ! docker-compose ps | grep -q "Up"; then
              echo "‚ùå Container not running"
              exit 1
            fi

            # Check health
            if ! docker-compose exec -T frontend curl -f http://localhost:3000/api/health; then
              echo "‚ùå Health check failed"
              exit 1
            fi

            echo "‚úÖ Deployment verified successfully"

  # 5. Ìó¨Ïä§ Ï≤¥ÌÅ¨
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Wait for application warmup
        run: sleep 30

      - name: Check application health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/api/health)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Application is healthy"
          else
            echo "‚ùå Health check failed with status: $response"
            exit 1
          fi

      - name: Check n8n integration
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.NEXT_PUBLIC_N8N_URL }}/healthz)
          if [ $response -eq 200 ]; then
            echo "‚úÖ n8n integration is healthy"
          else
            echo "‚ö†Ô∏è n8n health check returned: $response"
          fi

      - name: Generate deployment summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ github.event.inputs.environment || 'production' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: [${{ secrets.APP_URL }}](${{ secrets.APP_URL }})" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Application Health" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ n8n Integration" >> $GITHUB_STEP_SUMMARY

  # 6. Î°§Î∞± (Ïã§Ìå® Ïãú)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure()
    steps:
      - name: Rollback to previous version
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ~/gonsai2-frontend

            if [ -f docker-compose.yml.backup ]; then
              echo "üîÑ Rolling back to previous version..."

              # Stop current deployment
              docker-compose down

              # Restore backup
              mv docker-compose.yml.backup docker-compose.yml

              # Restart with previous version
              docker-compose up -d

              # Wait and verify
              sleep 10
              if docker-compose ps | grep -q "Up"; then
                echo "‚úÖ Rollback completed successfully"
              else
                echo "‚ùå Rollback failed - manual intervention required"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è No backup found - cannot rollback"
              exit 1
            fi

      - name: Send rollback notification
        if: always()
        run: |
          echo "## üîÑ Deployment Rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed and was rolled back to previous version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY

  # 7. Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always()
    steps:
      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "URL: ${{ secrets.APP_URL }}"

      - name: Send failure notification
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the workflow logs for details."
          echo "Commit: ${{ github.sha }}"
