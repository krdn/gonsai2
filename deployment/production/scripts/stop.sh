#!/bin/bash
# =============================================================================
# 프로덕션 환경 중지 스크립트
# =============================================================================

set -e

# 색상 출력
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 로깅 함수
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

# 확인 메시지
warning "⚠️  모든 서비스를 중지합니다"
echo -n "계속하시겠습니까? (yes/no): "
read -r CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    log "중지 취소됨"
    exit 0
fi

# =============================================================================
# 1. 현재 상태 저장 (선택사항)
# =============================================================================
echo -n "중지 전 백업을 생성하시겠습니까? (yes/no): "
read -r CREATE_BACKUP

if [ "$CREATE_BACKUP" = "yes" ]; then
    log "백업 생성 중..."
    ./scripts/backup.sh
    log "백업 완료"
fi

# =============================================================================
# 2. 서비스 중지
# =============================================================================
log "서비스 중지 중..."

# 단계별 중지 (역순)

# 1단계: 모니터링 및 프록시
log "1/4 모니터링 및 프록시 서비스 중지..."
docker-compose stop nginx grafana prometheus loki promtail alertmanager

# 2단계: 프론트엔드
log "2/4 프론트엔드 서비스 중지..."
docker-compose stop gonsai2-app

# 3단계: n8n
log "3/4 n8n 서비스 중지..."
docker-compose stop n8n n8n-worker

# 4단계: 데이터베이스
log "4/4 데이터베이스 서비스 중지..."
docker-compose stop postgres mongodb redis

log "모든 서비스 중지 완료"

# =============================================================================
# 3. 컨테이너 제거 (선택사항)
# =============================================================================
echo -n "컨테이너를 제거하시겠습니까? (볼륨은 유지됩니다) (yes/no): "
read -r REMOVE_CONTAINERS

if [ "$REMOVE_CONTAINERS" = "yes" ]; then
    log "컨테이너 제거 중..."
    docker-compose down
    log "컨테이너 제거 완료"
fi

# =============================================================================
# 4. 상태 확인
# =============================================================================
log "최종 상태:"
docker-compose ps

log "============================================"
log "중지 완료!"
log "============================================"
echo ""
log "다시 시작하려면: ./scripts/start.sh"
echo ""

exit 0
