# =============================================================================
# Alertmanager ì„¤ì •
# =============================================================================

global:
  # SMTP ì„¤ì • (ì´ë©”ì¼ ì•Œë¦¼ìš©)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@yourdomain.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'
  smtp_require_tls: true

  # Slack OAuth Token (ì„ íƒì‚¬í•­)
  slack_api_url: 'https://slack.com/api/chat.postMessage'

  # ê¸°ë³¸ ì•Œë¦¼ ì‹œê°„
  resolve_timeout: 5m

# ì•Œë¦¼ í…œí”Œë¦¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ë¼ìš°íŒ… ê·œì¹™
route:
  # ê¸°ë³¸ ìˆ˜ì‹ ì
  receiver: 'default-receiver'

  # ê·¸ë£¹í™” ì„¤ì •
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h

  # í•˜ìœ„ ë¼ìš°íŒ… ê·œì¹™
  routes:
    # Critical ì•Œë¦¼ - ì¦‰ì‹œ ì „ì†¡
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: true

    # ë°ì´í„°ë² ì´ìŠ¤ ì•Œë¦¼
    - match:
        category: database
      receiver: 'database-team'
      group_wait: 30s
      repeat_interval: 1h

    # n8n ì›Œí¬í”Œë¡œìš° ì•Œë¦¼
    - match:
        category: workflow
      receiver: 'workflow-team'
      group_wait: 1m
      repeat_interval: 30m

    # ë¦¬ì†ŒìŠ¤ ì•Œë¦¼
    - match:
        category: resources
      receiver: 'infrastructure-team'
      group_wait: 5m
      repeat_interval: 2h

    # ë°±ì—… ì•Œë¦¼
    - match:
        category: backup
      receiver: 'backup-team'
      repeat_interval: 24h

    # ì•¼ê°„ ì•Œë¦¼ ì–µì œ (warningë§Œ)
    - match:
        severity: warning
      active_time_intervals:
        - business-hours

# ì•Œë¦¼ ì–µì œ ê·œì¹™
inhibit_rules:
  # ServiceDownì´ ë°œìƒí•˜ë©´ ê°™ì€ ì„œë¹„ìŠ¤ì˜ ë‹¤ë¥¸ ì•Œë¦¼ ì–µì œ
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: '.+'
    equal:
      - 'job'
      - 'instance'

  # Critical ì•Œë¦¼ì´ ìˆìœ¼ë©´ ê°™ì€ ì¹´í…Œê³ ë¦¬ì˜ Warning ì–µì œ
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal:
      - 'category'
      - 'service'

# ì‹œê°„ ê°„ê²© ì •ì˜
time_intervals:
  # ì—…ë¬´ ì‹œê°„ (ì›”-ê¸ˆ, 9AM-6PM KST)
  - name: business-hours
    time_intervals:
      - weekdays: ['monday:friday']
        times:
          - start_time: '09:00'
            end_time: '18:00'
        location: 'Asia/Seoul'

# ìˆ˜ì‹ ì ì„¤ì •
receivers:
  # ==========================================================================
  # ê¸°ë³¸ ìˆ˜ì‹ ì (ëª¨ë“  ì•Œë¦¼)
  # ==========================================================================
  - name: 'default-receiver'
    email_configs:
      - to: 'team@yourdomain.com'
        headers:
          Subject: '[{{ .GroupLabels.severity | toUpper }}] {{ .GroupLabels.alertname }}'
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>
          <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
          <p><strong>í™˜ê²½:</strong> {{ .GroupLabels.environment }}</p>
          <p><strong>ìš”ì•½:</strong></p>
          <ul>
          {{ range .Alerts }}
            <li>{{ .Annotations.summary }}</li>
          {{ end }}
          </ul>

  # ==========================================================================
  # Critical ì•Œë¦¼ (ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”)
  # ==========================================================================
  - name: 'critical-alerts'
    # ì´ë©”ì¼
    email_configs:
      - to: 'oncall@yourdomain.com,team@yourdomain.com'
        headers:
          Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }}'
        send_resolved: true

    # Slack
    slack_configs:
      - channel: '#alerts-critical'
        api_url: '{{ .CommonAnnotations.slack_webhook_url }}'
        title: 'ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
        color: 'danger'

    # PagerDuty (ì„ íƒì‚¬í•­)
    # pagerduty_configs:
    #   - service_key: 'your-pagerduty-service-key'
    #     description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'

  # ==========================================================================
  # ë°ì´í„°ë² ì´ìŠ¤ íŒ€
  # ==========================================================================
  - name: 'database-team'
    email_configs:
      - to: 'database-team@yourdomain.com'
        headers:
          Subject: '[Database] {{ .GroupLabels.alertname }}'

    slack_configs:
      - channel: '#database-alerts'
        title: 'Database Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Component:* {{ .Labels.component }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # ==========================================================================
  # ì›Œí¬í”Œë¡œìš° íŒ€ (n8n)
  # ==========================================================================
  - name: 'workflow-team'
    email_configs:
      - to: 'workflow-team@yourdomain.com'
        headers:
          Subject: '[Workflow] {{ .GroupLabels.alertname }}'

    slack_configs:
      - channel: '#workflow-alerts'
        title: 'Workflow Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # ==========================================================================
  # ì¸í”„ë¼ íŒ€
  # ==========================================================================
  - name: 'infrastructure-team'
    email_configs:
      - to: 'infra-team@yourdomain.com'
        headers:
          Subject: '[Infrastructure] {{ .GroupLabels.alertname }}'

    slack_configs:
      - channel: '#infra-alerts'
        title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Instance:* {{ .Labels.instance }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # ==========================================================================
  # ë°±ì—… íŒ€
  # ==========================================================================
  - name: 'backup-team'
    email_configs:
      - to: 'backup-team@yourdomain.com'
        headers:
          Subject: '[Backup] {{ .GroupLabels.alertname }}'
        send_resolved: true
